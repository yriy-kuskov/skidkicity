# SkidkiCity: Глобальные правила разработки

## 1. СТРУКТУРА API И ИМПОРТЫ
- [cite_start]**CORE:** Базовые утилиты (uploadImage) живут в `src/lib/api.js`. [cite: 24]
- [cite_start]**MODULES:** Бизнес-логика строго разделена по файлам в `src/lib/api/`. 
  - Скидки: `deals.js`, Товары: `products.js`, Категории: `categories.js`, Внешний API: `external.js`.
- **ПРАВИЛО:** При рефакторинге всегда проверяй импорты. [cite_start]Не позволяй создавать "кашу" в одном файле. [cite: 26]

## 2. АСИНХРОННЫЕ ЗАПРОСЫ (AbortController) — DE FACTO
- **ОБЯЗАТЕЛЬНО:** Все асинхронные запросы в хуках или компонентах, зависящие от фильтров или ввода пользователя, ДОЛЖНЫ использовать `AbortController`.
- **РЕАЛИЗАЦИЯ:** Перед каждым новым вызовом API старый запрос должен быть отменен через `abortController.abort()`.
- **API ПЕРЕДАЧА:** Функции в `src/lib/api/` должны принимать объект `signal` и передавать его в Supabase/fetch как `{ abortSignal: signal }`.

## 3. ЛЕНИВАЯ ЗАГРУЗКА И СКРОЛЛ
- **ПЕРЕИСПОЛЬЗОВАНИЕ:** Логика бесконечного скролла должна быть вынесена в хук `useInfiniteScroll`.
- **UI:** Внизу каждого списка должен быть элемент `ref={lastElementRef}` для инициации подгрузки следующей страницы.
- **ЛОАДЕРЫ:** Разделять "глобальный лоадер" (первая загрузка на пустой экран) и "нижний лоадер" (догрузка страниц).

## 4. ОБРАБОТКА СОСТОЯНИЙ (StatusState)
- **ЕДИНЫЙ СТАНДАРТ:** Любые состояния списка (пусто, ошибка, поиск не дал результатов, медленный интернет, offline) ОБЯЗАТЕЛЬНО обрабатываются через компонент `StatusState`.
- **LITE-РЕЖИМ:** `StatusState` должен учитывать проп `isLiteMode` для отображения специфических подсказок (Zap icon) и действий в режиме экономии трафика.

## 5. PWA (Progressive Web App)
- **MANIFEST:** Любые изменения в названии, цветах или иконках должны отражаться в конфиге `VitePWA` внутри `vite.config.js`.
- **OFFLINE FIRST:** При разработке новых фич учитывать, что ядро приложения (assets) кэшируется. Проверять работу в режиме "Offline" в DevTools.
- **ASSETS:** Все PWA-иконки (`pwa-192x192.png`, `pwa-512x512.png`) и `favicon.ico` строго хранятся в папке `public/`.

## 6. СХЕМА ДАННЫХ (Supabase)
- **КАТЕГОРИИ:** Таблица `products` связана с `categories` через `category_id`. Текстовое поле `category` удалено. [cite: 27]
- [cite_start]**JOINS:** При любом запросе к товарам или скидкам ОБЯЗАТЕЛЬНО добавляй `.select('..., categories(name)')`. [cite: 28]
- [cite_start]**MAPPING:** В функциях API всегда делай "плоский" маппинг: преобразовывай `data.categories.name` в простое поле `category`. [cite: 29]

## 7. ЦЕНЫ И ТОЧНОСТЬ (КРИТИЧЕСКИ ВАЖНО)
- [cite_start]**ФОРМАТ:** Все цены — это `Number` с плавающей точкой. [cite: 30]
- [cite_start]**ОТОБРАЖЕНИЕ:** Всегда показывай копейки (2 знака после запятой) через `.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 })`. [cite: 31]
- [cite_start]**ЗАПРЕЩЕНО:** Использовать `Math.round()` для цен. [cite: 32]

## 8. СУЩНОСТИ И МЕДИА
- [cite_start]**РАЗДЕЛЕНИЕ ФОТО:** `image_url` — товар, `proof_image_url` — ценник. [cite: 33]
- [cite_start]**СЛАЙДЕР:** В `ImageSlider` первым идет товар, вторым — ценник. [cite: 34]
- **LITE MODE:** В `ProductCard` изображения и тяжелые элементы должны скрываться, если включен `liteMode`.

## 9. UI/UX И СТИЛИ (Tailwind)
- [cite_start]**MOBILE FIRST:** Сначала стили для мобильных. [cite: 36]
- [cite_start]**FORM INPUTS:** Для текстовых инпутов используй `text-base` (16px), чтобы избежать автозума в Safari. [cite: 37]
- [cite_start]**LOADING:** Кнопки отправки: `disabled={loading}` + спиннер `Loader2`. [cite: 38]

## 10. СТИЛЬ КОДА (Code Style)
- [cite_start]**SEMICOLONS:** ОБЯЗАТЕЛЬНО завершай каждую логическую строку точкой с запятой `;`. [cite: 43]
- [cite_start]**QUOTES:** Используй одинарные кавычки `'`. [cite: 44]
- **SPACING:** 2 пробела для отступа. [cite_start]Пробелы в импортах: `{ Name }`. [cite: 45]
- [cite_start]**NAMING:** Компоненты — `PascalCase`, функции — `camelCase`, API файлы — `snake_case`. [cite: 46]

## 11. ПРОТОКОЛ ПЕРЕДАЧИ КОДА И ДИЗАЙН
- **ФОРМАТ КОДА:**
  - Если правка внутри функции -> Присылай **ВСЮ функцию целиком**.
  - Если правки в разных местах или меняются импорты -> Присылай **ВЕСЬ файл целиком**.
  - ЗАПРЕЩЕНО присылать огрызки вида `// ... остальной код`.
- **ДИЗАЙН И РАЗМЕТКА:**
  - СТРОГО ЗАПРЕЩЕНО удалять существующие HTML-элементы, классы Tailwind или иконки, если это явно не требуется задачей.
  - При изменении логики визуальный стиль должен сохраняться на 100%.

## 12. ГЛОБАЛЬНЫЕ UI ПАТТЕРНЫ
- **LOADER:**
  - Никогда не блокируй весь экран (`fixed inset-0`), если загружается только часть контента.
  - Используй `absolute inset-0` внутри контейнера с `relative`.
  - Loader не должен перекрывать кнопки действий (StatusState) или навигацию.
- **ПОИСК (SEARCH):**
  - Ввод в строку поиска всегда должен использовать **DEBOUNCE** (задержка 500-800мс).
  - Живой поиск на каждый клик запрещен.