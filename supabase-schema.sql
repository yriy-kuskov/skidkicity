-- –°—Ö–µ–º–∞ –¥–ª—è Supabase (–≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ SQL Editor –≤ –¥–∞—à–±–æ—Ä–¥–µ Supabase)

-- –¢–∞–±–ª–∏—Ü–∞ –º–∞–≥–∞–∑–∏–Ω–æ–≤
CREATE TABLE IF NOT EXISTS stores (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name TEXT NOT NULL,
  logo TEXT
);

-- –¢–∞–±–ª–∏—Ü–∞ —Ç–æ–≤–∞—Ä–æ–≤
CREATE TABLE IF NOT EXISTS products (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  barcode TEXT UNIQUE NOT NULL,
  name TEXT NOT NULL,
  category TEXT,
  image_url TEXT
);

-- –¢–∞–±–ª–∏—Ü–∞ —Å–∫–∏–¥–æ–∫ (deals)
CREATE TABLE IF NOT EXISTS deals (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  product_id BIGINT NOT NULL REFERENCES products(id) ON DELETE CASCADE,
  store_id BIGINT NOT NULL REFERENCES stores(id),
  old_price DECIMAL(10,2) NOT NULL,
  new_price DECIMAL(10,2) NOT NULL,
  image_url TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- –ò–Ω–¥–µ–∫—Å—ã
CREATE INDEX IF NOT EXISTS idx_products_barcode ON products(barcode);
CREATE INDEX IF NOT EXISTS idx_deals_created_at ON deals(created_at DESC);

-- –ü–æ–ª–∏—Ç–∏–∫–∏ RLS (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω—ã) ‚Äî –ø—Ä–∏–º–µ—Ä –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è –∏ –∞–Ω–æ–Ω–∏–º–Ω–æ–π –∑–∞–ø–∏—Å–∏
-- ALTER TABLE products ENABLE ROW LEVEL SECURITY;
-- ALTER TABLE deals ENABLE ROW LEVEL SECURITY;
-- ALTER TABLE stores ENABLE ROW LEVEL SECURITY;
-- CREATE POLICY "Allow public read" ON products FOR SELECT USING (true);
-- CREATE POLICY "Allow public read" ON deals FOR SELECT USING (true);
-- CREATE POLICY "Allow public read" ON stores FOR SELECT USING (true);
-- CREATE POLICY "Allow anon insert" ON products FOR INSERT WITH CHECK (true);
-- CREATE POLICY "Allow anon insert" ON deals FOR INSERT WITH CHECK (true);

-- –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –º–∞–≥–∞–∑–∏–Ω–æ–≤
INSERT INTO stores (id, name, logo) VALUES
  (1, '–ü—è—Ç—ë—Ä–æ—á–∫–∞', 'üõí'),
  (2, '–ú–∞–≥–Ω–∏—Ç', 'üè™'),
  (3, '–ü–µ—Ä–µ–∫—Ä—ë—Å—Ç–æ–∫', 'üõçÔ∏è'),
  (4, '–õ–µ–Ω—Ç–∞', 'üè¨'),
  (5, '–ê—à–∞–Ω', 'üè¢')
ON CONFLICT (id) DO UPDATE SET name = EXCLUDED.name, logo = EXCLUDED.logo;

-- –ë–∞–∫–µ—Ç deal-images: —Å–æ–∑–¥–∞–π—Ç–µ –≤ Supabase Dashboard ‚Üí Storage ‚Üí New bucket
-- –ò–º—è: deal-images
-- Public bucket: –≤–∫–ª—é—á–∏—Ç—å (–¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö URL –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ)

-- 1. –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –∫–∞—Ç–µ–≥–æ—Ä–∏–π
CREATE TABLE IF NOT EXISTS categories (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name TEXT UNIQUE NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2. –ù–∞–ø–æ–ª–Ω—è–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
INSERT INTO categories (name) 
VALUES ('–ú–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã'), ('–•–ª–µ–±–æ–±—É–ª–æ—á–Ω—ã–µ –∏–∑–¥–µ–ª–∏—è'), ('–ú—è—Å–Ω—ã–µ –∏–∑–¥–µ–ª–∏—è'), 
       ('–û–≤–æ—â–∏ –∏ —Ñ—Ä—É–∫—Ç—ã'), ('–ö—Ä—É–ø—ã'), ('–ù–∞–ø–∏—Ç–∫–∏'), ('–†–∞–∑–Ω–æ–µ')
ON CONFLICT (name) DO NOTHING;

-- 3. –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É —Å–≤—è–∑–∏ –≤ products
ALTER TABLE products ADD COLUMN IF NOT EXISTS category_id BIGINT REFERENCES categories(id);

-- 4. –ü–µ—Ä–µ–Ω–æ—Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö (–º–∞–ø–ø–∏–Ω–≥ —Ç–µ–∫—Å—Ç–∞ –≤ ID)
-- –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –≤—Å–µ—Ö —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –µ—Å—Ç—å –≤ —Ç–æ–≤–∞—Ä–∞—Ö
INSERT INTO categories (name)
SELECT DISTINCT category FROM products 
WHERE category IS NOT NULL
ON CONFLICT (name) DO NOTHING;

-- –ü—Ä–æ—Å—Ç–∞–≤–ª—è–µ–º ID —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫–∞–∂–¥–æ–º—É —Ç–æ–≤–∞—Ä—É
UPDATE products 
SET category_id = categories.id 
FROM categories 
WHERE products.category = categories.name;

-- 5. –£–î–ê–õ–ï–ù–ò–ï –°–¢–ê–†–û–ô –ö–û–õ–û–ù–ö–ò
-- –¢–µ–ø–µ—Ä—å, –∫–æ–≥–¥–∞ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –≤ category_id, —Å—Ç–∞—Ä–∞—è —Ç–µ–∫—Å—Ç–æ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ –Ω–µ –Ω—É–∂–Ω–∞
ALTER TABLE products DROP COLUMN IF EXISTS category;

-- 6. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (RLS)
ALTER TABLE categories ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Allow public read" ON categories FOR SELECT USING (true);
CREATE POLICY "Allow anon insert" ON categories FOR INSERT WITH CHECK (true);

-- –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É –≤ —Ç–∞–±–ª–∏—Ü—É products, —á—Ç–æ–±—ã —Ö—Ä–∞–Ω–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —à—Ç—Ä–∏—Ö–∫–æ–¥ —Ç–æ–≤–∞—Ä–∞
ALTER TABLE products 
ADD COLUMN IF NOT EXISTS barcode_image_url TEXT;